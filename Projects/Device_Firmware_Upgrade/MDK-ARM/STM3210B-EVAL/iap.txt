; generated by ARM C/C++ Compiler, 5.03 [Build 76]
; commandline ArmCC [--list --split_sections --debug -c --asm --interleave -o.\stm3210b-eval\iap.o --asm_dir=.\STM3210B-EVAL\ --list_dir=.\STM3210B-EVAL\ --depend=.\stm3210b-eval\iap.d --cpu=Cortex-M3 --apcs=interwork -O3 -I..\inc -I..\..\..\Libraries\CMSIS\Device\ST\STM32F10x\Include -I..\..\..\Libraries\STM32_USB-FS-Device_Driver\inc -I..\..\..\Libraries\STM32F10x_StdPeriph_Driver\inc -I..\..\..\Utilities\STM32_EVAL -I..\..\..\Utilities\STM32_EVAL\Common -I..\..\..\Utilities\STM32_EVAL\STM3210B_EVAL -I..\DFU\inc -ID:\Keil5\ARM\RV31\INC -ID:\Keil5\ARM\PACK\ARM\CMSIS\3.20.4\CMSIS\Include -ID:\Keil5\ARM\Inc\ST\STM32F10x -D__MICROLIB -DUSE_STDPERIPH_DRIVER -DSTM32F10X_MD -DUSE_STM3210B_EVAL ..\DFU\src\iap.c]
                          THUMB

                          AREA ||i.IAP_FLASH_ReadFlag||, CODE, READONLY, ALIGN=2

                  IAP_FLASH_ReadFlag PROC
;;;339    /************************************************************************/
;;;340    uint16_t IAP_FLASH_ReadFlag(void)
000000  4801              LDR      r0,|L1.8|
;;;341    {
;;;342    	return STMFLASH_ReadHalfWord(IAP_FLASH_FLAG_ADDR);   
000002  f7ffbffe          B.W      STMFLASH_ReadHalfWord
;;;343    }
;;;344    
                          ENDP

000006  0000              DCW      0x0000
                  |L1.8|
                          DCD      0x08002800

                          AREA ||i.IAP_FLASH_WriteFlag||, CODE, READONLY, ALIGN=2

                  IAP_FLASH_WriteFlag PROC
;;;330    /************************************************************************/
;;;331    void IAP_FLASH_WriteFlag(uint16_t flag) 
000000  b501              PUSH     {r0,lr}
;;;332    {
;;;333    	FLASH_Unlock();
000002  f7fffffe          BL       FLASH_Unlock
;;;334    	STMFLASH_Write(IAP_FLASH_FLAG_ADDR, &flag, 1);
000006  2201              MOVS     r2,#1
000008  4669              MOV      r1,sp
00000a  4803              LDR      r0,|L2.24|
00000c  f7fffffe          BL       STMFLASH_Write
;;;335    	FLASH_Lock();
000010  f7fffffe          BL       FLASH_Lock
;;;336    }
000014  bd08              POP      {r3,pc}
;;;337    
                          ENDP

000016  0000              DCW      0x0000
                  |L2.24|
                          DCD      0x08002800

                          AREA ||i.IAP_IntoDFU||, CODE, READONLY, ALIGN=2

                  IAP_IntoDFU PROC
;;;54       /* Enter DFU mode */
;;;55     void IAP_IntoDFU(void)
000000  490a              LDR      r1,|L3.44|
;;;56     {
;;;57       uint16_t i = 0;
;;;58       DeviceState = STATE_dfuERROR;
000002  200a              MOVS     r0,#0xa
000004  2400              MOVS     r4,#0                 ;57
000006  7008              STRB     r0,[r1,#0]
;;;59       DeviceStatus[0] = STATUS_ERRFIRMWARE;
000008  310c              ADDS     r1,r1,#0xc
00000a  7008              STRB     r0,[r1,#0]
;;;60       DeviceStatus[4] = DeviceState;
00000c  7108              STRB     r0,[r1,#4]
;;;61     
;;;62       Set_System();
00000e  f7fffffe          BL       Set_System
;;;63       Set_USBClock();
000012  f7fffffe          BL       Set_USBClock
;;;64       USB_Init();  
000016  f7fffffe          BL       USB_Init
;;;65       
;;;66       /* Main loop */
;;;67       while (1)
;;;68       {
;;;69     	i++;
;;;70     	if(i>=65535)
00001a  f64f70ff          MOV      r0,#0xffff
                  |L3.30|
00001e  1c64              ADDS     r4,r4,#1              ;69
000020  b2a4              UXTH     r4,r4                 ;69
000022  4284              CMP      r4,r0
000024  d3fb              BCC      |L3.30|
;;;71     	{
;;;72     	  i=0;
000026  2400              MOVS     r4,#0
000028  e7f9              B        |L3.30|
;;;73     //	  if (DFU_Button_Read() != 0x00)//pushed
;;;74     //	  {
;;;75     //		IAP_FLASH_WriteFlag(APPRUN_FLAG_DATA);
;;;76     //		//NVIC_SystemReset();
;;;77     //		IAP_RunApp();
;;;78     //	  }
;;;79     	}
;;;80       }
;;;81     }
;;;82     
                          ENDP

00002a  0000              DCW      0x0000
                  |L3.44|
                          DCD      ||.data||

                          AREA ||i.IAP_RunApp||, CODE, READONLY, ALIGN=2

                  IAP_RunApp PROC
;;;345    /************************************************************************/
;;;346    int8_t IAP_RunApp(void)
000000  480a              LDR      r0,|L4.44|
;;;347    {
000002  b510              PUSH     {r4,lr}
;;;348    	if (((*(__IO uint32_t*)ApplicationAddress) & 0x2FFE0000 ) == 0x20000000)
000004  6801              LDR      r1,[r0,#0]
000006  4a0a              LDR      r2,|L4.48|
000008  4011              ANDS     r1,r1,r2
00000a  f1b15f00          CMP      r1,#0x20000000
00000e  d002              BEQ      |L4.22|
;;;349    	{   
;;;350    		#if (IAP_MODE == UART_MODE)
;;;351    		SerialPutString("\r\n Run to app.\r\n");
;;;352    		#endif
;;;353    		JumpAddress = *(__IO uint32_t*) (ApplicationAddress + 4);
;;;354    		Jump_To_Application = (pFunction) JumpAddress;
;;;355    		__set_MSP(*(__IO uint32_t*) ApplicationAddress);
;;;356    		Jump_To_Application();
;;;357    		return 0;
;;;358    	}
;;;359    	else
;;;360    	{
;;;361    		#if (IAP_MODE == UART_MODE)
;;;362    		SerialPutString("\r\n Run to app error.\r\n");
;;;363    		#endif
;;;364    		return -1;
000010  f04f30ff          MOV      r0,#0xffffffff
;;;365    	}
;;;366    }
000014  bd10              POP      {r4,pc}
                  |L4.22|
000016  6841              LDR      r1,[r0,#4]            ;353
000018  4a06              LDR      r2,|L4.52|
00001a  6091              STR      r1,[r2,#8]            ;354  ; JumpAddress
00001c  6051              STR      r1,[r2,#4]            ;355  ; Jump_To_Application
00001e  6800              LDR      r0,[r0,#0]            ;355
000020  f3808808          MSR      MSP,r0                ;355
000024  4788              BLX      r1                    ;356
000026  2000              MOVS     r0,#0                 ;357
000028  bd10              POP      {r4,pc}
;;;367    
                          ENDP

00002a  0000              DCW      0x0000
                  |L4.44|
                          DCD      0x08003000
                  |L4.48|
                          DCD      0x2ffe0000
                  |L4.52|
                          DCD      ||.data||

                          AREA ||.data||, DATA, ALIGN=2

                  DeviceState
000000  00000000          DCB      0x00,0x00,0x00,0x00
                  Jump_To_Application
                          DCD      0x00000000
                  JumpAddress
                          DCD      0x00000000
                  DeviceStatus
                          DCD      0x00000000
000010  0000              DCB      0x00,0x00

;*** Start embedded assembler ***

#line 1 "..\\DFU\\src\\iap.c"
	AREA ||.rev16_text||, CODE, READONLY
	THUMB
	EXPORT |__asm___5_iap_c_0f65cd3a____REV16|
#line 129 "D:\\Keil5\\ARM\\PACK\\ARM\\CMSIS\\3.20.4\\CMSIS\\Include\\core_cmInstr.h"
|__asm___5_iap_c_0f65cd3a____REV16| PROC
#line 130

 rev16 r0, r0
 bx lr
	ENDP
	AREA ||.revsh_text||, CODE, READONLY
	THUMB
	EXPORT |__asm___5_iap_c_0f65cd3a____REVSH|
#line 144
|__asm___5_iap_c_0f65cd3a____REVSH| PROC
#line 145

 revsh r0, r0
 bx lr
	ENDP

;*** End   embedded assembler ***
